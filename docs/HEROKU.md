# Basic Heroku deployment

If you're unfamiliar with Heroku, [read this first](https://devcenter.heroku.com/articles/quickstart)

## Configure the app:

### Create a separate branch for your Heroku deployment.

    git checkout -b heroku

### Configure redis.yml
Save redis.yml.sample as redis.yml, then modify `production:` to use environment variables provided by Heroku and the Redis provider.
*This example assumes you're using redistogo, but any of the redis providers will do.*

*config/redis.yml*

    ...

    production:
      uri: <%= uri = URI.parse(ENV['REDISTOGO_URL']) if Rails.env.production? %>
      host: <%= uri.host if uri %>
      port: <%= uri.port if uri %>
      password: <%= uri.password if uri %>
      db: 0
      cache_db: 2

### Comment out config/redis.yml from .gitignore

We want to include redis.yml when we push to Heroku.

*.gitignore*

    - config/redis.yml
    + # config/redis.yml

### Then commit your changes to git

    git add .
    git commit -m "ready for Heroku"


## Configure Heroku:

### Create the heroku app

    heroku create your-app-name

##### The basic Discourse deployment for Heroku requires a minimum of redistogo:mini or equivalent. This is a service that will cost you money. For alternatives to this see the Advanced Heroku deployment instructions (coming soon).

### Add the redistogo addon or equivalent.

    heroku addons:add redistogo:mini

We'll also want to add the Heroku Scheduler addon, this saves us from running a separate clock process, reducing the cost of the app.

    heroku addons:add scheduler:standard

### Generate a secret token in the terminal

    rake secret

### Push the generated secret to the stored heroku environment variables

    heroku config:add SECRET_TOKEN=<generated secret>

##### The next step is optional, as it is still in experimental 'labs' status with Heroku. You can choose to precompile your assets locally before deployment instead. If you do choose to precompile, remember to do it each time you deploy.

This command makes the environment variables available to heroku during deployment, which is necessary for the application to compile properly.

    heroku labs:enable user-env-compile -a your-app-name

##### If you should need to change or add environment variables for any reason, you will need to remove `user-env-compile`, then re-apply it after making the changes. This will then require you to make a commit, even if it is an empty commit, and then push to Heroku for the changes to be applied

If needed, you can remove the user-env-compile option with this.

    heroku labs:disable user-env-compile -a your-app-name

### Push your Heroku branch to the Heroku remote

    git push heroku heroku:master

### Migrate and seed the database

    heroku run rake db:migrate db:seed_fu

You should now be able to visit your app at http://your-app-name.herokuapp.com

## Configure the deployed application:

### First, log into your app using your auth provider of choice.

Once you have created your first user account, connect to the Heroku console to make the user an Admin.

    heroku run console

Then enter the following commands

    u = User.first
    u.admin = true
    u.approved = true
    u.save

### Provision the Heroku Scheduler

This will allow Heroku Scheduler to cue up tasks rather than running a separate clock process.
In the [Heroku dashboard](https://dashboard.heroku.com/apps), select your app, then click on **Heroku Scheduler Standard** under your Add-ons.

Next, click Add Job and create a scheduled task for each of the following:

TASK: `rake enqueue_digest_emails` FREQUENCY: `Daily` NEXT RUN: `06:00`

TASK: `rake category_stats` FREQUENCY: `Daily` NEXT RUN: `04:00`

TASK: `rake calculate_avg_time` FREQUENCY: `Every 10 minutes`

TASK: `rake feature_topics` FREQUENCY: `Every 10 minutes`

TASK: `rake calculate_score` FREQUENCY: `Every 10 minutes`

TASK: `rake calculate_view_counts` FREQUENCY: `Every 10 minutes`

TASK: `rake version_check` FREQUENCY: `Daily` NEXT RUN: `01:00`

### Start Sidekiq

In the [Heroku dashboard](https://dashboard.heroku.com/apps) you will see the separate processes available for your app. You will only need to start the sidekiq process for your application to run properly. The clock process is covered by Heroku Scheduler, and you can even remove this from the Procfile before deploying if you so wish. The worker process has been generated by default and can be ignored. As you can see **the Sidekiq process costs $34 monthly** to run. If you want to reduce this cost, check out the Advanced Heroku deployment(coming soon).

## Running the application locally

Foreman allows you to run your application locally in the same manner as heroku. It loads environment variables via the .env file and instantiates the application using the Procfile. In the sample file, we have set the `Rails.env` using `RAILS_ENV='development'`.

### Create the .env file from the sample
Simply save .env.sample as .env

### Create the database

    bundle exec foreman run rake db:create

### Migrate and seed the database

    bundle exec foreman run rake db:migrate db:seed_fu

### Run using Foreman

    bundle exec foreman run

### Use pry

    bundle exec foreman run pry